#!/bin/bash
TMP_REGEXP="(\.tmp|\.sw\w|Thumbs.db|\.stackdump)$"

echo "----------------------------------------------------------------------"
echo "START: vltsyncci"
echo "----------------------------------------------------------------------"

for index in 1 2; do

echo "----------------------------------------------------------------------"
echo "START: vlt st $@"
echo "----------------------------------------------------------------------"
VLTST=$(vlt st "$@" | grep -v '\.dir|_jcr_content|\.bak|\.vltfix|\.wip' | grep -v "M\s*\.content.xml" | grep -v '\.theirs|\.mine|\.base')
echo "$VLTST"
echo "----------------------------------------------------------------------"
echo "END: vlt st $@"
echo "----------------------------------------------------------------------"
echo "----------------------------------------------------------------------"
echo "START: vlt add/rm/ci"
echo "----------------------------------------------------------------------"
echo "$VLTST" | awk "/$TMP_REGEXP/ { print \$2 }" | (xargs -t -r -L10 -P1 rm       --force) &&
echo "$VLTST" | awk "/$TMP_REGEXP/ { print \$2 }" | (xargs -t -r -L10 -P5 vltrmci  --force) &
echo "$VLTST" | awk "/^!/  { print \$2 }" | grep -vP "$TMP_REGEXP" | (xargs -t -r -L10 -P5 vltrmci  --force) 
echo "$VLTST" | awk "/^?/  { print \$2 }" | grep -vP "$TMP_REGEXP" | (xargs -t -r -L10 -P5 vltaddci --force) 
echo "$VLTST" | awk "/^\w/ { print \$2 }" | grep -vP "$TMP_REGEXP" | perl -p -e 's!(^([^/]*/?){1,3}).*!\\$1!' | sort | uniq | uniqdir | (xargs -t -r -L1 -P5 vlt ci --force)
echo "----------------------------------------------------------------------"
echo "END: vlt add/rm/ci $@"
echo "----------------------------------------------------------------------"

echo "----------------------------------------------------------------------"
echo "START: vlt st $@"
echo "----------------------------------------------------------------------"
## Try all the remaining files one by one
VLTST=$(vlt st "$@" | grep -v '\.dir|_jcr_content|\.bak|\.vltfix|\.wip' | grep -v "M\s*\.content.xml" | grep -v '\.theirs|\.mine|\.base')
echo "$VLTST"
echo "----------------------------------------------------------------------"
echo "END: vlt st $@"
echo "----------------------------------------------------------------------"
echo "----------------------------------------------------------------------"
echo "START: xargs -L1 -P10 vlt add/rm/ci"
echo "----------------------------------------------------------------------"
echo "$VLTST" | awk "/^\w/ { print \$2 }" | xargs -t -r -L1 -P10 vlt ci --force
echo "----------------------------------------------------------------------"
echo "END: xargs -L1 -P10 vlt add/rm/ci"
echo "----------------------------------------------------------------------"

done;

echo "----------------------------------------------------------------------"
echo "START: vlt st $@"
echo "----------------------------------------------------------------------"
vlt st "$@"
echo "----------------------------------------------------------------------"
echo "END: vlt st $@"
echo "----------------------------------------------------------------------"
echo "----------------------------------------------------------------------"
echo "END: vltsyncci"
echo "----------------------------------------------------------------------"
